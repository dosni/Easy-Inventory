@page "/categoryList"
@using ServiceLayer.Model;
@using ServiceLayer.ProductCategoryServices;
@using ServiceLayer.ProductCategoryServices.Concrete;

<PageTitle>CategoryList</PageTitle>

@inject CategoryServices _CategoryServices
@inject IDialogService _dialogService


@if (IsLoading == true)
{
    <div style="width: 300px; display: grid; grid-gap: 12px; grid-auto-flow: column;">
        <FluentProgress></FluentProgress>
    </div>
}
@if (cats != null)
{
    <FluentDataGrid Items="@cats" ResizableColumns=true GridTemplateColumns="0.4fr 0.6fr 0.3fr 0.3fr"
                    style="height: 250px;overflow:auto;">

        <PropertyColumn Property="@(c => c.CategoryId)" Title="Category Id" Align="Align.Start" />
        <PropertyColumn Property="@(c => c.Category)" Title="Category" Align="Align.Start" />

        <TemplateColumn Title="Edit">
            <FluentButton Appearance="Appearance.Accent" @onclick="@(() => Edit(context.CategoryId,context.Category))">Edit</FluentButton>
        </TemplateColumn>
        <TemplateColumn Title="Delete">
            <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size20.Delete())" @onclick="@(() => Delete(context.CategoryId,context.Category))">Delete</FluentButton>
        </TemplateColumn>
    </FluentDataGrid>
}
@code {
    private bool IsLoading { get; set; } = false;
    IQueryable<CategoryDto>? cats;

    protected override async Task OnInitializedAsync()
    {

        base.OnInitialized();
        await Loading();

    }
    private async Task Loading()
    {
        IsLoading = true;
        await Task.Delay(200);
        cats = (await _CategoryServices.GetEFCategoryListAsycn()).AsQueryable();
        IsLoading = false;

    }

    private async void Edit(int Id, string cat)
    {
        _navman.NavigateTo($"categoryUpdate/{Id}/{cat}");

    }
    private async void Delete(int Id, string cat)
    {
        try
        {
            IsLoading = true;
            await Task.Delay(200);
            ServiceResponseDTO<bool> result = new();
            result = await _CategoryServices.DeleteCategoryAsync(Id);
            IsLoading = false;
            if (result.Success == true)
            {
                _dialogService.ShowInfo(result.Message, "Delete");
            }
            else
            {
                _dialogService.ShowWarning(result.Message, "Delete");
            }
            result = new();
            await Loading();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            string msg = ex.Message;
            IsLoading = false;
            return;
        }

    }
}
